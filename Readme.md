# Разворачивание инфраструктуры

### terraform - разворачивание необходимой инфраструктуры в YC
- на текущий момент разворачивается k8s, ingress, prometheus, grafana, jenkins 
- jenkins-у заливается kubeconfig полученный от модуля admins (install.sh provisioner для jenkins)
- jenkins целенаправленно разворачивается как отдельный host (jenkins в k8s - тонкости docker in docker - пока в процессе изучения)
- На текущий момент при запуске jenkins - следовать его инструкциям по донастройке + надо поставить docker-pipelines плагин и прописать кред на докер-хаб c id=dockerhub_id
- в terraform обратить внимание на зависимости модулей - это важно для корректной последовательности создания и удаления ресурсов
- Набор yml переработан/обновлен и основан на https://github.com/claustrophobia-com/yandex-cloud-kubernetes
- у клаустрафобии хосты в кубере делились по назначению, для текущего задания закоментил это разделение, но в будущем может пригодиться идея

### Установка
- настроить yc (если это еще не сделано)
- в каталоге terrafrom выполнить:  terraform init
- Создать копию файла с входными переменными  cp terraform.tfvars.example terrafrom.tfvars
- Актуализируем значения в файле переменных
- Для деплоя в корне запустить run.sh
- Для удаления всего stop.sh
- Все реквизиты для подключения к сервисам terraform выведет в output
- Пароль к Jenkins следует перед выводом output, в строках вида:

```
module.jenkins.yandex_compute_instance.app (remote-exec): got file, here it is
module.jenkins.yandex_compute_instance.app (remote-exec): password

```
- для сервисов создается отдельный namespace: aznamespace - это в принципе не есть хорошо - т.к. ns все-таки выдает админ кластера с ограничением по ресусрам - автоматизировать его создание это может не очень хороший подход

### Описание terraform:
- из интересного: понравилось вариант создания локального ресурса с переменными для helm чартов( можно посмотреть на примере grafana).
- main.tf - основной файл

#### модули:
- cluster - разворачивание кластера k8s (в зависимостях у него модуль для разворачивания node-groups)
- iam - авторизационная составляющая для кластера
- vpc - разворачивания подсетей под кластер в YC
- jenkins - jenkins :), обратить внимание на install.sh, который используется для доустановки к дженку всего необходимого (в файле есть комментарии). Стандартный образ YC с Jenk - не очень.
- nginx-ingress - модуль разворачивания ingress (используется provider helm для terraform)
- grafana - модуль для разворачивания grafana и prometheus (используется provider helm для terraform). Для графаны в основном файле модуля настраивается datasource прома и добавляются пара стандартных dashboards для k8s и prometheus
- admins - вспомогательный модуль для учетных данных (его описание смотри в репе клаустрафобии)

### todo
- актуализировать описание
