# Разворачивание инфраструктуры

### terraform - разворачивание необходимой инфраструктуры в YC
- на текущий момент разворачивается k8s, ingress, prometheus, grafana, jenkins 
- jenkins-у заливается kubeconfig полученный от модуля admins (install.sh provisioner для jenkins)
- jenkins целенаправленно разворачивается как отдельный host (jenkins в k8s - тонкости docker in docker - пока в процессе изучения)
- На текущий момент при запуске jenkins - следовать его инструкциям по донастройке
- в terraform обратить внимание на зависимости модулей - это важно для корректной последовательности создания и удаления ресурсов
- Набор yml переработан/обновлен и основан на https://github.com/claustrophobia-com/yandex-cloud-kubernetes
- у клаустрафобии хосты в кубере делились по назначению, для текущего задания закоментил это разделение, но в будущем может пригодиться идея

### Установка
- настроить yc (если это еще не сделано)
- в каталоге terrafrom выполнить:  terraform init
- Создать копию файла с входными переменными  cp terraform.tfvars.example terrafrom.tfvars
- Актуализируем значения в файле переменных
- Для деплоя в корне запустить run.sh
- Для удаления всего stop.sh

### Описание terraform:
- main.tf - основной файл
- модули:
-- cluster - разворачивание кластера k8s (в зависимостях у него модуль для разворачивания node-groups)
-- iam - авторизационная составляющая для кластера
-- vpc - разворачивания подсетей под кластер в YC
-- jenkins - jenkins :)
-- nginx-ingress - модуль разворачивания ingress (используется provider helm для terraform)
-- grafana - модуль для разворачивания grafana и prometheus (используется provider helm для terraform)
-- admins - вспомогательный модуль для учетных данных (его описание смотри в репе клаустрафобии)

- из интересного: понравилось вариант создания локального ресурса с переменными для helm чартов( можно посмотреть на примере grafana).

### todo

- попробовать автоматизироть преднастройку jenkins или вывод или задание админского пароля
- опционально добавить в jenkins kubernetes agent
- опционально подчистить код из claustrophobia
- актуализировать описание